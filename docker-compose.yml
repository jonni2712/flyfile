# ============================================================================
# FlyFile - Docker Compose Configuration
# Secure file transfer platform - Self-hosted version
#
# This project is developed with vibe coding using Claude Code by Anthropic
# https://github.com/anthropics/claude-code
#
# Usage:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: docker-compose up -d
#   3. Access FlyFile at http://localhost:3000
#
# For production, use docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================================================

services:
  # ==========================================================================
  # FlyFile Application
  # ==========================================================================
  flyfile:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
        - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
        - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        - NEXT_PUBLIC_BASE_URL=${NEXT_PUBLIC_BASE_URL:-http://localhost:3000}
        - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:-}
        - NEXT_PUBLIC_RECAPTCHA_SITE_KEY=${NEXT_PUBLIC_RECAPTCHA_SITE_KEY:-}
    container_name: flyfile
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # Firebase Admin (server-side)
      - FIREBASE_ADMIN_PROJECT_ID=${FIREBASE_ADMIN_PROJECT_ID}
      - FIREBASE_ADMIN_CLIENT_EMAIL=${FIREBASE_ADMIN_CLIENT_EMAIL}
      - FIREBASE_ADMIN_PRIVATE_KEY=${FIREBASE_ADMIN_PRIVATE_KEY}
      # Storage (S3-compatible: MinIO, R2, AWS S3, etc.)
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-minio}
      - STORAGE_ENDPOINT=${STORAGE_ENDPOINT:-http://minio:9000}
      - STORAGE_ACCESS_KEY=${STORAGE_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${STORAGE_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=${STORAGE_BUCKET:-flyfile}
      - STORAGE_REGION=${STORAGE_REGION:-us-east-1}
      - STORAGE_PUBLIC_URL=${STORAGE_PUBLIC_URL:-http://localhost:9000/flyfile}
      # Legacy R2 support (if using Cloudflare R2)
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-}
      # Redis for rate limiting
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      # Email (SMTP)
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_SECURE=${MAIL_SECURE:-false}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-FlyFile}
      # Security
      - PASSWORD_SALT=${PASSWORD_SALT}
      - TOTP_ENCRYPTION_KEY=${TOTP_ENCRYPTION_KEY}
      # Optional: Stripe (for paid features)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      # Optional: reCAPTCHA
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY:-}
      # Admin
      - ADMIN_EMAILS=${ADMIN_EMAILS:-}
      # Self-hosted mode flag
      - SELF_HOSTED=true
    depends_on:
      - redis
      - minio
    networks:
      - flyfile-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==========================================================================
  # Redis - Rate Limiting & Caching
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: flyfile-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - flyfile-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # MinIO - S3-Compatible Object Storage
  # ==========================================================================
  minio:
    image: minio/minio:latest
    container_name: flyfile-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio-data:/data
    networks:
      - flyfile-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ==========================================================================
  # MinIO Setup - Creates bucket on first run
  # ==========================================================================
  minio-setup:
    image: minio/mc:latest
    container_name: flyfile-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb myminio/$${STORAGE_BUCKET:-flyfile} --ignore-existing;
      mc anonymous set download myminio/$${STORAGE_BUCKET:-flyfile};
      echo 'Bucket created successfully';
      exit 0;
      "
    networks:
      - flyfile-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  redis-data:
    driver: local
  minio-data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================
networks:
  flyfile-network:
    driver: bridge
